/*
 * Comm.c
 *
 *  Created on: Sep 16, 2016
 *      Author: mkamstra
 */
#include <msp430.h>
#include <stdint.h>
#include <stdbool.h>
#include "Comm.h"

bool debounce0 = false;
bool debounce1 = false;


uint8_t sci_1_pUp[39] = { 0x50, 0x50, 0x50, 0x0B,   // Science board 1 ON
						  0x01, 0xFF, 0x02, 0x00,
						  0x03, 0x00, 0x04, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00 };

uint8_t sci_2_pUp[39] = { 0x50, 0x50, 0x50, 0x0B,   // Science board 2 ON
						  0x01, 0x00, 0x02, 0xFF,
						  0x03, 0x00, 0x04, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00 };

uint8_t sci_3_pUp[39] = { 0x50, 0x50, 0x50, 0x0B,   // Science board 3 ON
						  0x01, 0x00, 0x02, 0x00,
						  0x03, 0xFF, 0x04, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00 };

uint8_t sci_4_pUp[39] = { 0x50, 0x50, 0x50, 0x0B,   // Science board 4 ON
						  0x01, 0x00, 0x02, 0x00,
						  0x03, 0x00, 0x04, 0xFF,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00 };

uint8_t sci_x_pDown[39] = { 0x50, 0x50, 0x50, 0x0B,   // Science board X OFF
						  0x01, 0x00, 0x02, 0x00,
						  0x03, 0x00, 0x04, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00, 0x00,
						  0x00, 0x00, 0x00 };



void powerUp(uint8_t sci_x_board){		
	P4OUT &= ~(BIT4 + BIT5 + BIT6 + BIT7); // Turn off all boards on HUB
	if (sci_x_board == 1){P4OUT |= BIT4;}
	if (sci_x_board == 2){P4OUT |= BIT5;}
	if (sci_x_board == 3){P4OUT |= BIT6;}
	if (sci_x_board == 4){P4OUT |= BIT7;}
	__delay_cycles(500); // Turn on Science board 1 on HUB
	uint8_t j = 0;
	while (j < 39)
			{
				if (sci_x_board == 1){write_UART (sci_1_pUp[j]);}		// Request power up from NSL
				if (sci_x_board == 2){write_UART (sci_2_pUp[j]);}		// Request power up from NSL
				if (sci_x_board == 3){write_UART (sci_3_pUp[j]);}		// Request power up from NSL
				if (sci_x_board == 4){write_UART (sci_4_pUp[j]);}		// Request power up from NSL
				j++;
			}
			j = 0;
}

void powerDown(uint8_t sci_x_board){
	uint8_t j = 0;
	while (j < 39)
			{
				write_UART (sci_x_pDown[j]);		// Request power up from NSL
				j++;
			}
			j = 0;
	__delay_cycles(500);
	P4OUT &= ~(BIT4 + BIT5 + BIT6 + BIT7);	// Turn off all boards on HUB
}

int Sci_Ready(void){
	if (P4IN & BIT1){debounce0 = true;}
	__delay_cycles(50);
	if (P4IN & BIT1){debounce1 = true;}
	if (debounce0 && debounce1){
		debounce0 = false;
		debounce1 = false;
		return 1;
	}
	else return 0;
	}
	
void Start_Timer(void){
	TA0R = 0X0000;
	TA0CCTL0 &= ~CCIFG; // Clears the interrupt flag
	TA0CCR0 = 0xFFFF; 	// wait 1 second
	timer = 0;
	timeout = false; // Clears the flag in the main function
}

uint8_t getTimer(void) {
	return timer;
}

